<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/checkout.css" />
    <title>Check-Out</title>
    <style>
      .booking-summary table {
        width: 100%;
        border-collapse: collapse;
      }
      .booking-summary th, 
      .booking-summary td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
      }
      .complete-btn {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 8px 16px;
        cursor: pointer;
      }
      .delete-btn {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 8px 16px;
        cursor: pointer;
      }
      #messageContainer {
        margin-top: 20px;
        padding: 10px;
      }
      .success {
        background-color: #dff0d8;
        color: #3c763d;
      }
      .error {
        background-color: #f2dede;
        color: #a94442;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <div class="sidebar">
        <div class="profile">
          <div class="profile-image">
            <img id="img-id" src="./assets/img1.jpg" />
          </div>
          <div class="profile-info">
            <h2>Radisson Blu</h2>
            <p>Dashboard</p>
          </div>
        </div>

        <nav class="nav-menu">
          <div class="nav-item">
            <a href="dashboard.html">
              <i class="icon">üè†</i>
              <span>Dashboard</span>
            </a>
          </div>
          <div class="nav-item">
            <a href="rooms.html">
              <i class="icon">üõèÔ∏è</i>
              <span>Rooms</span>
            </a>
          </div>
          <div class="nav-item">
            <a href="bookings.html">
              <i class="icon">üìù</i>
              <span>Bookings</span>
            </a>
          </div>
          <div class="nav-item active">
            <a href="checkout.html">
              <i class="icon">‚úÖ</i>
              <span>Payments</span>
            </a>
          </div>
          <div class="nav-item">
            <a href="older_bookings.html">
              <i class="icon">üìö</i>
              <span>Older Bookings</span>
            </a>
          </div>
          <div class="nav-item">
            <a href="registration.html">
              <i class="icon">üë•</i>
              <span>Registration</span>
            </a>
          </div>
          <div class="nav-item logout">
            <a href="logout.html">
              <i class="icon">üö™</i>
              <span>Log Out</span>
            </a>
          </div>
        </nav>
      </div>

      <main>
        <section class="booking-summary">
          <h2>Your Booking Summary</h2>
          <table id="bookingTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Room Type</th>
                <th>Check-In Date</th>
                <th>Check-Out Date</th>
                <th>Room Price</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="bookingSummaryBody">
            </tbody>
          </table>
          <div id="messageContainer"></div>
        </section>
      </main>
    </div>

    <script>
      function completeBooking(bookingId) {
        const messageContainer = document.getElementById('messageContainer');
        
        // Create form data
        const formData = new FormData();
        formData.append('booking_id', bookingId);

        // Send request to complete booking
        fetch('php/complete_booking.php', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(result => {
          if (result.status === 'success') {
            messageContainer.innerHTML = `
              <div class="success">
                ${result.message}. Redirecting to Older Bookings...
              </div>
            `;
            
            // Remove the completed booking row
            const rowToRemove = document.querySelector(`button[data-id="${bookingId}"]`).closest('tr');
            rowToRemove.remove();

            // Redirect to older bookings after 2 seconds
            setTimeout(() => {
              window.location.href = 'older_bookings.html';
            }, 2000);
          } else {
            messageContainer.innerHTML = `
              <div class="error">
                ${result.message}
              </div>
            `;
          }
        })
        .catch(error => {
          messageContainer.innerHTML = `
            <div class="error">
              Error: ${error.message}
            </div>
          `;
        });
      }

      function deleteBooking(bookingId) {
  const messageContainer = document.getElementById('messageContainer');
  
  // Confirm deletion
  if (!confirm('Are you sure you want to delete this booking?')) {
    return;
  }

  // Create form data
  const formData = new FormData();
  formData.append('booking_id', bookingId);

  // Send request to delete booking
  fetch('php/delete_booking.php', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(result => {
    if (result.status === 'success') {
      messageContainer.innerHTML = `
        <div class="success">
          ${result.message}.
        </div>
      `;
      
      // Remove the deleted booking row
      const rowToRemove = document.querySelector(`button[data-id="${bookingId}"]`).closest('tr');
      rowToRemove.remove();
    } else {
      messageContainer.innerHTML = `
        <div class="error">
          ${result.message}
        </div>
      `;
    }
  })
  .catch(error => {
    messageContainer.innerHTML = `
      <div class="error">
        Error: ${error.message}
      </div>
    `;
  });
}


      fetch('php/get_active_bookings.php')
      .then(response => response.json())
      .then(data => {
        const bookingSummaryBody = document.getElementById('bookingSummaryBody');
        
        if (data.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td colspan="7" style="text-align: center;">No active bookings found.</td>
          `;
          bookingSummaryBody.appendChild(row);
        } else {
          data.forEach(booking => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${booking.name}</td>
              <td>${booking.email}</td>
              <td>${booking.room_type}</td>
              <td>${booking.checkin_date}</td>
              <td>${booking.checkout_date}</td>
              <td>$${booking.room_price}</td>
              <td>
                <button class="delete-btn" data-id="${booking.id}" onclick="deleteBooking(${booking.id})">Delete</button>
                <button class="complete-btn" data-id="${booking.id}" onclick="completeBooking(${booking.id})">Complete</button>
              </td>
            `;
            bookingSummaryBody.appendChild(row);
          });
        }
      })
      .catch(error => console.error('Error fetching active bookings:', error));
    </script>
  </body>
</html>